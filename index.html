<?php
// index.php - Zobrazeni obsahu adresare

// ------------------------------------------------------------
// Konfigurace
define('DIR_FIRST', 1);
define('SHOW_BACK', 1);
define('SHOW_DATE', 1);
define('SHOW_SIZE', 1);

// ------------------------------------------------------------
// Deklarace funkci

// ------------------------------------------------------------
// Porovnani polozek seznamu souboru
function cmp_files_item($a, $b) {
  if ((DIR_FIRST) && ($a['dir'] != $b['dir'])) {
    return ($a['dir'] > $b['dir']) ? -1 : 1;
  }
  if ($a['name'] == $b['name']) return 0;
  return ($a['name'] > $b['name']) ? 1 : -1;
}

// ------------------------------------------------------------
// Funkce formatuje velikost souboru
function format_size($size) {
  $ap = array(' ','K','M','G','T','P','E','Z','Y');
  $pidx = 0;
  $rmain = 0;
  if ($size < 973) {
    return sprintf('%3d ', $size);
  }
  while ($size >= 973) {
    $rmain = $size & 1023;
    $size = $size >> 10;
    $pidx++;
  }
  if (($size < 9) || (($size == 9) && ($rmain < 973))) {
    if (($rmain = (($rmain * 5) + 256) / 512) >= 10) {
      $size++;
      $rmain = 0;
    }
    return sprintf('%d.%d%s', $size, $rmain, $ap[$pidx]);
  }
  if ($rmain >= 512) $size++;
  return sprintf('%3d%s', $size, $ap[$pidx]);
}

// ------------------------------------------------------------
// Funkce MAIN
$path = dirname($_SERVER['SCRIPT_NAME']);
if (strlen($path) <= 1) $path = '/';

// Inicializace seznamu souboru
$files = array();

// Nacteni obsahu adresare
$hdir = opendir(".");
while ($file = readdir($hdir)) {
  if ((substr($file, 0, 1) == '.') && ($file != '..')) continue;
  if ($file == basename(__FILE__)) continue;
  if (is_dir($file)) {
    array_push($files, array('dir' => 1, 'name' => $file, 'date' => filemtime($file), 'size' => 0));
  } else {
    array_push($files, array('dir' => 0, 'name' => $file, 'date' => filemtime($file), 'size' => filesize($file)));
  }
}
closedir($hdir);

// Serazeni seznamu souboru
usort($files, 'cmp_files_item');

// ------------------------------------------------------------
// Zobrazeni HTML
?>
<html>
<head>
<title>Index of <?php echo $path; ?></title>
</head>
<body background="/img/pozadi.png">
<h1>Index of <?php echo $path; ?></h1>
<pre><hr>
<?php
$nlen = 23;
if (!SHOW_DATE) $nlen += 18;
if (!SHOW_SIZE) $nlen += 6;
foreach ($files as $file) {
  if ($file['dir']) {
    if ($file['name'] == '..') {
      if ($path == '/') continue;
      if (!SHOW_BACK) continue;
      $icon = 'back.gif';
      $desc = 'Parent Directory';
    } else {
      $icon = 'folder.gif';
      $desc = $file['name'];
    }
    $alti = '[DIR]';
    $href = $file['name'].'/';
  } else {
    $icon = 'unknown.gif';
    $alti = '[   ]';
    $href = $file['name'];
    $desc = $file['name'];
  }
  if (strlen($desc) > $nlen) {
    $desc = substr($desc, 0, ($nlen - 3)).'..>';
  }
  if (SHOW_DATE) {
    if ($file['name'] == '..') {
      $date = str_repeat(' ', 18);
    } else {
      $date = date('  d.m.Y H:i', $file['date']);
    }
  } else {
    $date = '';
  }
  if (SHOW_SIZE) {
    if ($file['dir']) {
      $size = '    - ';
    } else {
      $size = '  '.format_size($file['size']);
    }
  } else {
    $size = '';
  }
  echo '<img src="/img/icons/'.$icon.'" alt="'.$alti.'"> <a href="'.$href.'">'.htmlspecialchars($desc).'</a>'.str_repeat(' ', $nlen - strlen($desc)).$date.$size."\n";
}
?>
<hr></pre>
<body>
</html>
